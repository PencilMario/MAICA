name: Package Application with Pyinstaller

on: push

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: win
            runs-on: windows-latest

    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v3

      - name: Create Executable for MAICA
        uses: theSanguss/pyinstaller-action@patch-1
        with:
          python_ver: '3.12'
          spec: 'maica/maica_starter.py'
          requirements: 'requirements.txt'
          upload_exe_with_name: 'maica_starter'
          options: --onefile, --name "maica_starter",

      - name: Create Executable for Register
        uses: theSanguss/pyinstaller-action@patch-1
        with:
          python_ver: '3.11'
          spec: 'maica/create_account.py'
          requirements: 'requirements_2.txt'
          upload_exe_with_name: 'Register'
          options: --onefile, --name "Register",

      - name: Create Release Tag
        id: create_tag
        if: matrix.platform == 'win'
        shell: bash
        run: |
          tag_name="v$(date +'%Y%m%d')-${{ github.sha }}"
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag "$tag_name"
          git push origin "$tag_name"
          echo "tag=$tag_name" >> $GITHUB_OUTPUT

      - name: Download MAICA Executable
        uses: actions/download-artifact@v4
        with:
          name: MAICA
          path: artifacts/

      - name: Download Register Executable
        uses: actions/download-artifact@v4
        with:
          name: Register
          path: artifacts/

      - name: Unzip Artifacts
        shell: bash
        run: |
          cd artifacts
          unzip '*.zip'
          ls

      - name: Prepare Release Files
        shell: bash
        run: |
          mkdir -p dist
          find artifacts -name "maica_starter.exe" -exec cp {} dist/maica_starter.exe \;
          find artifacts -name "Register.exe" -exec cp {} dist/Register.exe \;
          ls dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main' && matrix.platform == 'win'
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          files: |
            dist/maica_starter.exe
            dist/Register.exe
            maica/env_example
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
